import{S as e,p as t,r,s,a as i,n,f as a,b as o,c as u,d as c,e as h,u as l,j as d,q as p}from"./ssr.mjs";import"../nitro/nitro.mjs";import"node:buffer";import"node:timers";import"node:events";import"node:process";import"cloudflare:workers";import"node:net";import"node:stream";import"node:util";import"node:crypto";import"node:path";import"node:url";import"node:assert";import"node:zlib";import"node:async_hooks";import"node:stream/web";var f=class extends e{constructor(e,r){super(),this.options=r,this.#e=e,this.#t=null,this.#r=t(),this.options.experimental_prefetchInRender||this.#r.reject(new Error("experimental_prefetchInRender feature flag is not enabled")),this.bindMethods(),this.setOptions(r)}#e;#s=void 0;#i=void 0;#n=void 0;#a;#o;#r;#t;#u;#c;#h;#l;#d;#p;#f=new Set;bindMethods(){this.refetch=this.refetch.bind(this)}onSubscribe(){1===this.listeners.size&&(this.#s.addObserver(this),shouldFetchOnMount(this.#s,this.options)?this.#y():this.updateResult(),this.#m())}onUnsubscribe(){this.hasListeners()||this.destroy()}shouldFetchOnReconnect(){return shouldFetchOn(this.#s,this.options,this.options.refetchOnReconnect)}shouldFetchOnWindowFocus(){return shouldFetchOn(this.#s,this.options,this.options.refetchOnWindowFocus)}destroy(){this.listeners=new Set,this.#R(),this.#b(),this.#s.removeObserver(this)}setOptions(e){const t=this.options,n=this.#s;if(this.options=this.#e.defaultQueryOptions(e),void 0!==this.options.enabled&&"boolean"!=typeof this.options.enabled&&"function"!=typeof this.options.enabled&&"boolean"!=typeof r(this.options.enabled,this.#s))throw new Error("Expected enabled to be a boolean or a callback that returns a boolean");this.#v(),this.#s.setOptions(this.options),t._defaulted&&!s(this.options,t)&&this.#e.getQueryCache().notify({type:"observerOptionsUpdated",query:this.#s,observer:this});const a=this.hasListeners();a&&shouldFetchOptionally(this.#s,n,this.options,t)&&this.#y(),this.updateResult(),!a||this.#s===n&&r(this.options.enabled,this.#s)===r(t.enabled,this.#s)&&i(this.options.staleTime,this.#s)===i(t.staleTime,this.#s)||this.#Q();const o=this.#O();!a||this.#s===n&&r(this.options.enabled,this.#s)===r(t.enabled,this.#s)&&o===this.#p||this.#g(o)}getOptimisticResult(e){const t=this.#e.getQueryCache().build(this.#e,e),r=this.createResult(t,e);return function(e,t){if(!s(e.getCurrentResult(),t))return!0;return!1}(this,r)&&(this.#n=r,this.#o=this.options,this.#a=this.#s.state),r}getCurrentResult(){return this.#n}trackResult(e,t){return new Proxy(e,{get:(e,r)=>(this.trackProp(r),t?.(r),Reflect.get(e,r))})}trackProp(e){this.#f.add(e)}getCurrentQuery(){return this.#s}refetch({...e}={}){return this.fetch({...e})}fetchOptimistic(e){const t=this.#e.defaultQueryOptions(e),r=this.#e.getQueryCache().build(this.#e,t);return r.fetch().then(()=>this.createResult(r,t))}fetch(e){return this.#y({...e,cancelRefetch:e.cancelRefetch??!0}).then(()=>(this.updateResult(),this.#n))}#y(e){this.#v();let t=this.#s.fetch(this.options,e);return e?.throwOnError||(t=t.catch(n)),t}#Q(){this.#R(),i(this.options.staleTime,this.#s)}#O(){return("function"==typeof this.options.refetchInterval?this.options.refetchInterval(this.#s):this.options.refetchInterval)??!1}#g(e){this.#b(),this.#p=e}#m(){this.#Q(),this.#g(this.#O())}#R(){this.#l&&(clearTimeout(this.#l),this.#l=void 0)}#b(){this.#d&&(clearInterval(this.#d),this.#d=void 0)}createResult(e,s){const i=this.#s,n=this.options,u=this.#n,c=this.#a,h=this.#o,l=e!==i?e.state:this.#i,{state:d}=e;let p,f={...d},y=!1;if(s._optimisticResults){const t=this.hasListeners(),r=!t&&shouldFetchOnMount(e,s),o=t&&shouldFetchOptionally(e,i,s,n);(r||o)&&(f={...f,...a(d.data,e.options)}),"isRestoring"===s._optimisticResults&&(f.fetchStatus="idle")}let{error:m,errorUpdatedAt:R,status:b}=f;p=f.data;let v=!1;if(void 0!==s.placeholderData&&void 0===p&&"pending"===b){let e;u?.isPlaceholderData&&s.placeholderData===h?.placeholderData?(e=u.data,v=!0):e="function"==typeof s.placeholderData?s.placeholderData(this.#h?.state.data,this.#h):s.placeholderData,void 0!==e&&(b="success",p=o(u?.data,e,s),y=!0)}if(s.select&&void 0!==p&&!v)if(u&&p===c?.data&&s.select===this.#u)p=this.#c;else try{this.#u=s.select,p=s.select(p),p=o(u?.data,p,s),this.#c=p,this.#t=null}catch(e){this.#t=e}this.#t&&(m=this.#t,p=this.#c,R=Date.now(),b="error");const Q="fetching"===f.fetchStatus,O="pending"===b,g="error"===b,I=O&&Q,S=void 0!==p,x={status:b,fetchStatus:f.fetchStatus,isPending:O,isSuccess:"success"===b,isError:g,isInitialLoading:I,isLoading:I,data:p,dataUpdatedAt:f.dataUpdatedAt,error:m,errorUpdatedAt:R,failureCount:f.fetchFailureCount,failureReason:f.fetchFailureReason,errorUpdateCount:f.errorUpdateCount,isFetched:f.dataUpdateCount>0||f.errorUpdateCount>0,isFetchedAfterMount:f.dataUpdateCount>l.dataUpdateCount||f.errorUpdateCount>l.errorUpdateCount,isFetching:Q,isRefetching:Q&&!O,isLoadingError:g&&!S,isPaused:"paused"===f.fetchStatus,isPlaceholderData:y,isRefetchError:g&&S,isStale:isStale(e,s),refetch:this.refetch,promise:this.#r,isEnabled:!1!==r(s.enabled,e)};if(this.options.experimental_prefetchInRender){const finalizeThenableIfPossible=e=>{"error"===x.status?e.reject(x.error):void 0!==x.data&&e.resolve(x.data)},recreateThenable=()=>{const e=this.#r=x.promise=t();finalizeThenableIfPossible(e)},r=this.#r;switch(r.status){case"pending":e.queryHash===i.queryHash&&finalizeThenableIfPossible(r);break;case"fulfilled":"error"!==x.status&&x.data===r.value||recreateThenable();break;case"rejected":"error"===x.status&&x.error===r.reason||recreateThenable()}}return x}updateResult(){const e=this.#n,t=this.createResult(this.#s,this.options);if(this.#a=this.#s.state,this.#o=this.options,void 0!==this.#a.data&&(this.#h=this.#s),s(t,e))return;this.#n=t;this.#I({listeners:(()=>{if(!e)return!0;const{notifyOnChangeProps:t}=this.options,r="function"==typeof t?t():t;if("all"===r||!r&&!this.#f.size)return!0;const s=new Set(r??this.#f);return this.options.throwOnError&&s.add("error"),Object.keys(this.#n).some(t=>{const r=t;return this.#n[r]!==e[r]&&s.has(r)})})()})}#v(){const e=this.#e.getQueryCache().build(this.#e,this.options);if(e===this.#s)return;const t=this.#s;this.#s=e,this.#i=e.state,this.hasListeners()&&(t?.removeObserver(this),e.addObserver(this))}onQueryUpdate(){this.updateResult(),this.hasListeners()&&this.#m()}#I(e){u.batch(()=>{e.listeners&&this.listeners.forEach(e=>{e(this.#n)}),this.#e.getQueryCache().notify({query:this.#s,type:"observerResultsUpdated"})})}};function shouldFetchOnMount(e,t){return function(e,t){return!1!==r(t.enabled,e)&&void 0===e.state.data&&!("error"===e.state.status&&!1===t.retryOnMount)}(e,t)||void 0!==e.state.data&&shouldFetchOn(e,t,t.refetchOnMount)}function shouldFetchOn(e,t,s){if(!1!==r(t.enabled,e)&&"static"!==i(t.staleTime,e)){const r="function"==typeof s?s(e):s;return"always"===r||!1!==r&&isStale(e,t)}return!1}function shouldFetchOptionally(e,t,s,i){return(e!==t||!1===r(i.enabled,e))&&(!s.suspense||"error"!==e.state.status)&&isStale(e,s)}function isStale(e,t){return!1!==r(t.enabled,e)&&e.isStaleByTime(i(t.staleTime,e))}var y=c.createContext(!1);y.Provider;var m=c.createContext(function(){let e=!1;return{clearReset:()=>{e=!1},reset:()=>{e=!0},isReset:()=>e}}()),defaultThrowOnError=(e,t)=>void 0===t.state.data;function useBaseQuery(e,t,r){const s=c.useContext(y),i=c.useContext(m),a=l(),o=a.defaultQueryOptions(e);a.getDefaultOptions().queries?._experimental_beforeQuery?.(o),o._optimisticResults=s?"isRestoring":"optimistic",(e=>{if(e.suspense){const clamp=e=>"static"===e?e:Math.max(e??1e3,1e3),t=e.staleTime;e.staleTime="function"==typeof t?(...e)=>clamp(t(...e)):clamp(t),"number"==typeof e.gcTime&&(e.gcTime=Math.max(e.gcTime,1e3))}})(o),((e,t)=>{(e.suspense||e.throwOnError||e.experimental_prefetchInRender)&&(t.isReset()||(e.retryOnMount=!1))})(o,i),(e=>{c.useEffect(()=>{e.clearReset()},[e])})(i),a.getQueryCache().get(o.queryHash);const[d]=c.useState(()=>new t(a,o)),p=d.getOptimisticResult(o),f=!s&&!1!==e.subscribed;if(c.useSyncExternalStore(c.useCallback(e=>{const t=f?d.subscribe(u.batchCalls(e)):n;return d.updateResult(),t},[d,f]),()=>d.getCurrentResult(),()=>d.getCurrentResult()),c.useEffect(()=>{d.setOptions(o)},[o,d]),((e,t)=>e?.suspense&&t.isPending)(o,p))throw((e,t,r)=>t.fetchOptimistic(e).catch(()=>{r.clearReset()}))(o,d,i);if((({result:e,errorResetBoundary:t,throwOnError:r,query:s,suspense:i})=>e.isError&&!t.isReset()&&!e.isFetching&&s&&(i&&void 0===e.data||h(r,[e.error,s])))({result:p,errorResetBoundary:i,throwOnError:o.throwOnError,query:a.getQueryCache().get(o.queryHash),suspense:o.suspense}))throw p.error;return a.getDefaultOptions().queries?._experimental_afterQuery?.(o,p),o.experimental_prefetchInRender,o.notifyOnChangeProps?p:d.trackResult(p)}function DeferredQuery(){const e=(t=p({queryKey:["deferred"],queryFn:async()=>(await new Promise(e=>setTimeout(e,3e3)),{message:"Hello deferred from the server!",status:"success",time:new Date})}),useBaseQuery({...t,enabled:!0,suspense:!0,throwOnError:defaultThrowOnError,placeholderData:void 0},f));var t;return d.jsxs("div",{children:[d.jsx("h1",{children:"Deferred Query"}),d.jsxs("div",{children:["Status: ",e.data.status]}),d.jsxs("div",{children:["Message: ",e.data.message]}),d.jsxs("div",{children:["Time: ",e.data.time.toISOString()]})]})}const SplitComponent=function(){const[e,t]=c.useState(0);return d.jsxs("div",{className:"p-2",children:[d.jsx(c.Suspense,{fallback:"Loading Middleman...",children:d.jsx(DeferredQuery,{})}),d.jsxs("div",{children:["Count: ",e]}),d.jsx("div",{children:d.jsx("button",{onClick:()=>t(e+1),children:"Increment"})})]})};export{SplitComponent as component};
//# sourceMappingURL=deferred-CdxJuQ03.mjs.map
